###########################################
# Nginx default.conf
# Configuration minimale de reverse proxy utilisée dans ce projet.
# - Route /api/ vers l'application Flask (service Docker `flask-app`)
# - Route /site/ vers le site statique servi par le service `html-app`
###########################################

server {
    # Port HTTP exposé par le proxy
    listen 80;
    # Nom du serveur (par défaut localhost pour dev local)
    server_name localhost;

    # Route racine: sert les fichiers statiques montés dans /usr/share/nginx/html
    # try_files permet de renvoyer index.html pour les routes SPA (fallback)
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # -------------------------------
    # Proxy pour l'API Flask
    # Les requêtes vers /api/ sont transmises au service Docker `flask-app:5000`
    # - proxy_pass: adresse du service dans le réseau Docker (nom du service)
    # - proxy_set_header: transmet des en-têtes utiles (host, IP, scheme)
    # -------------------------------
    location /api/ {
        # Important: la barre oblique finale sur proxy_pass permet de
        # réécrire correctement l'URI (on passe /api/foo -> /foo sur Flask)
        proxy_pass http://flask-app:5000/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # -------------------------------
    # Proxy vers le site statique (html-app)
    # Les requêtes /site/ sont redirigées vers le conteneur `html-app`
    # -------------------------------
    location /site/ {
        proxy_pass http://html-app:80/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Pages d'erreurs personnalisées (optionnel)
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
}
